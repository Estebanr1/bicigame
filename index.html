<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö¥‚Äç‚ôÇÔ∏è Bike Race Sensor Game V11 FINAL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @keyframes pedal {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(180deg); }
        }
        
        @keyframes bike-move {
            0%, 100% { transform: translateX(0px); }
            50% { transform: translateX(5px); }
        }
        
        @keyframes handlebar-shake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-2deg); }
            75% { transform: rotate(2deg); }
        }
        
        .pedaling {
            animation: pedal 0.5s linear infinite;
        }
        
        .bike-moving {
            animation: bike-move 0.3s ease-in-out infinite;
        }
        
        .handlebar-active {
            animation: handlebar-shake 0.2s ease-in-out infinite;
        }
        
        .cyclist-left {
            transform: scaleX(-1);
        }
        
        .connection-pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .speed-indicator {
            background: linear-gradient(90deg, #10b981 0%, #f59e0b 50%, #ef4444 100%);
        }

        .v11-badge {
            background: linear-gradient(45deg, #10b981, #3b82f6);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin: 10px 0;
            animation: pulse 2s infinite;
        }

        .v11-title {
            background: linear-gradient(45deg, #3b82f6, #10b981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-green-50 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8">
        <!-- P√°gina de Inicio V11 FINAL -->
        <div id="inicio" class="page active">
            <div class="max-w-2xl mx-auto text-center">
                <h1 class="text-4xl font-bold text-gray-800 mb-4 v11-title">
                    <i class="fas fa-bicycle text-blue-600"></i>
                    Bike Race Sensor Game V11 FINAL
                </h1>
                
                <div class="v11-badge">
                    ‚úÖ VERSI√ìN 11 FINAL - Sin bloqueos - Lectura peri√≥dica optimizada
                </div>
                
                <div class="text-xs text-green-600 font-mono mb-8">
                    ID: bike-race-sensor-game-v11-final | Build: <span id="buildTime"></span>
                </div>
                
                <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
                    <h2 class="text-2xl font-semibold mb-4">Bienvenido al Juego de Pedaleo V11 FINAL</h2>
                    <p class="text-gray-600 mb-6">
                        Conect√° tu dispositivo NodeMCU con sensor infrarrojo HW-511 para comenzar.
                    </p>
                    
                    <div id="estadoConexion" class="mb-6 p-4 rounded-lg bg-blue-50 border border-blue-200">
                        <div class="connection-pulse">
                            <i class="fas fa-rocket text-blue-600"></i>
                            <span class="text-blue-800 ml-2">üöÄ VERSI√ìN 11 FINAL - Verificando compatibilidad...</span>
                        </div>
                    </div>
                    
                    <!-- Estado del sensor f√≠sico V11 FINAL -->
                    <div id="sensorStatus" class="hidden mb-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div id="sensorIndicator" class="p-3 rounded-lg border bg-blue-100 border-blue-300">
                                <div class="text-center">
                                    <div class="text-2xl mb-1">üîç</div>
                                    <div class="text-sm font-medium">Estado Sensor V11 FINAL</div>
                                    <div class="text-xs" id="sensorStatusText">Esperando...</div>
                                </div>
                            </div>
                            <div id="ledIndicator" class="p-3 rounded-lg border bg-gray-100 border-gray-300">
                                <div class="text-center">
                                    <div id="ledDot" class="w-4 h-4 rounded-full mx-auto mb-1 bg-gray-400"></div>
                                    <div class="text-sm font-medium">LED NodeMCU V11 FINAL</div>
                                    <div class="text-xs" id="ledStatusText">‚ö´ OFF</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contador de clicks total V11 FINAL -->
                    <div id="clickCounter" class="hidden mb-6 p-4 bg-blue-100 rounded-lg">
                        <div class="text-center">
                            <div id="totalClicks" class="text-3xl font-bold text-blue-800 mb-1">0</div>
                            <div class="text-sm text-blue-600">Total Clicks Detectados V11 FINAL</div>
                            <div id="lastClickTime" class="text-xs text-blue-500"></div>
                        </div>
                    </div>

                    <!-- Datos del sensor en tiempo real V11 FINAL -->
                    <div id="sensorDataDisplay" class="hidden mb-6 p-3 bg-gray-100 rounded-lg">
                        <p class="text-sm text-gray-600">√öltimo dato del sensor V11 FINAL:</p>
                        <code id="sensorDataCode" class="text-sm font-mono font-bold text-gray-600"></code>
                    </div>

                    <!-- Log de datos serie raw V11 FINAL -->
                    <div id="rawDataLog" class="hidden mb-6 p-3 bg-gray-50 rounded-lg max-h-32 overflow-y-auto">
                        <p class="text-xs text-gray-500 mb-2">Datos serie V11 FINAL recibidos:</p>
                        <div id="rawDataList"></div>
                    </div>
                    
                    <button id="detectarNodeMCU" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors mb-4">
                        <i class="fas fa-usb mr-2"></i>
                        Conectar NodeMCU V11 FINAL por USB
                    </button>

                    <!-- Botones de control V11 FINAL -->
                    <div id="controlButtons" class="hidden mb-6">
                        <div class="grid grid-cols-3 gap-2">
                            <button id="testSensor" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded transition-colors">
                                üß™ Probar V11 FINAL
                            </button>
                            <button id="requestStatus" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded transition-colors">
                                üìä Estado V11 FINAL
                            </button>
                            <button id="disconnectNodeMCU" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded transition-colors">
                                üîå Desconectar V11 FINAL
                            </button>
                        </div>
                    </div>

                    <!-- Log de conexi√≥n V11 FINAL -->
                    <div id="connectionLogDisplay" class="hidden mb-6 p-3 bg-blue-50 rounded-lg max-h-40 overflow-y-auto">
                        <p class="text-xs text-blue-600 mb-2">Log de conexi√≥n V11 FINAL:</p>
                        <div id="connectionLogList"></div>
                    </div>

                    <div class="text-sm text-gray-500 space-y-2 mb-6">
                        <p><strong>Estado Actual V11 FINAL:</strong></p>
                        <ul class="text-left space-y-1">
                            <li id="connectionStatusLi">‚Ä¢ ‚ùå Conexi√≥n: No conectado</li>
                            <li id="commandStatusLi">‚Ä¢ ‚ùå Env√≠o de comandos: N/A</li>
                            <li id="clickStatusLi">‚Ä¢ üîç Recepci√≥n de "click": Verificar sensor</li>
                            <li>‚Ä¢ üì° Sensor HW-511 en D2: Debe enviar "click" al activarse</li>
                        </ul>
                    </div>
                    
                    <div class="mt-6 text-sm text-gray-500">
                        <p>Conexi√≥n por: WiFi Direct, WiFi tradicional, Cable USB o t√°ctil/clic</p>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                    <h3 class="text-lg font-semibold mb-4">M√©todos de Conexi√≥n Alternativos V11 FINAL</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button class="connection-method p-4 border-2 border-gray-200 rounded-lg hover:border-blue-400 transition-colors" data-method="wifi-direct">
                            <i class="fas fa-wifi text-2xl text-blue-600 mb-2"></i>
                            <p class="text-sm">WiFi Direct V11</p>
                        </button>
                        <button class="connection-method p-4 border-2 border-gray-200 rounded-lg hover:border-blue-400 transition-colors" data-method="wifi">
                            <i class="fas fa-network-wired text-2xl text-green-600 mb-2"></i>
                            <p class="text-sm">WiFi V11</p>
                        </button>
                        <button class="connection-method p-4 border-2 border-gray-200 rounded-lg hover:border-blue-400 transition-colors" data-method="usb">
                            <i class="fas fa-usb text-2xl text-purple-600 mb-2"></i>
                            <p class="text-sm">Cable USB V11</p>
                        </button>
                        <button class="connection-method p-4 border-2 border-gray-200 rounded-lg hover:border-blue-400 transition-colors" data-method="manual">
                            <i class="fas fa-hand-pointer text-2xl text-orange-600 mb-2"></i>
                            <p class="text-sm">T√°ctil/Clic V11</p>
                        </button>
                    </div>
                </div>

                <!-- C√≥digo NodeMCU V11 FINAL -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold mb-4">üîß C√≥digo NodeMCU Ultra Simple V11 FINAL</h3>
                    <div class="bg-gray-900 text-green-400 p-4 rounded-lg text-sm font-mono overflow-x-auto">
                        <pre>// C√≥digo NodeMCU ULTRA SIMPLE V11 FINAL - Sin bloqueos
const int sensorPin = D2;
const int ledPin = LED_BUILTIN;

bool lastState = HIGH;
unsigned long lastTime = 0;

void setup() {
  Serial.begin(115200);
  pinMode(sensorPin, INPUT_PULLUP);
  pinMode(ledPin, OUTPUT);
  digitalWrite(ledPin, HIGH);
  
  delay(500);
  Serial.println("Sistema V11 FINAL listo para detectar sensor");
}

void loop() {
  bool currentState = digitalRead(sensorPin);
  
  // Detectar activaci√≥n
  if (currentState == LOW && lastState == HIGH) {
    if (millis() - lastTime > 200) { // Debounce
      Serial.println("click");
      
      // LED r√°pido
      digitalWrite(ledPin, LOW);
      delay(50);
      digitalWrite(ledPin, HIGH);
      
      lastTime = millis();
    }
  }
  
  lastState = currentState;
  
  // Comandos simples
  if (Serial.available()) {
    String cmd = Serial.readStringUntil('\n');
    cmd.trim();
    
    if (cmd == "TEST_SENSOR") {
      Serial.println("click");
      digitalWrite(ledPin, LOW);
      delay(100);
      digitalWrite(ledPin, HIGH);
    }
    else if (cmd == "STATUS") {
      Serial.print("Sensor V11 FINAL: ");
      Serial.println(digitalRead(sensorPin) ? "HIGH" : "LOW");
    }
  }
  
  delay(5); // Muy peque√±o delay V11 FINAL
}</pre>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        ‚ö†Ô∏è IMPORTANTE: Este c√≥digo V11 FINAL es ultra simple y no deber√≠a causar bloqueos
                    </p>
                </div>
            </div>
        </div>

        <!-- P√°gina de Selecci√≥n de Modo V11 FINAL -->
        <div id="seleccionModo" class="page hidden">
            <div class="max-w-2xl mx-auto text-center">
                <h1 class="text-3xl font-bold text-gray-800 mb-8 v11-title">Seleccion√° el modo de juego V11 FINAL</h1>
                
                <div class="mb-4 space-y-2">
                    <div class="v11-badge" id="connectionBadge">
                        Conectado V11 FINAL via Manual
                    </div>
                    <div id="totalClicksDisplay" class="text-sm text-blue-600 hidden">
                        üéØ Total clicks V11 FINAL detectados: <span id="totalClicksCount">0</span>
                    </div>
                    <div id="sensorStatusGame" class="flex items-center justify-center gap-4 hidden">
                        <div class="flex items-center gap-2">
                            <div id="ledStatusGame" class="w-2 h-2 rounded-full bg-gray-400"></div>
                            <span class="text-sm">LED V11 FINAL: <span id="ledStatusGameText">OFF</span></span>
                        </div>
                        <div class="text-sm text-gray-600">Sensor V11 FINAL: <span id="sensorStatusGameText">Esperando...</span></div>
                    </div>
                </div>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="bg-white rounded-lg shadow-lg p-8 hover:shadow-xl transition-shadow">
                        <div class="text-6xl mb-4">
                            <i class="fas fa-user text-blue-600"></i>
                        </div>
                        <h3 class="text-xl font-semibold mb-4">Jugador Individual V11 FINAL</h3>
                        <p class="text-gray-600 mb-6">
                            <span id="singlePlayerDescription">Activa el sensor HW-511 V11 FINAL para pedalear</span>
                        </p>
                        <p class="text-xs text-gray-500 mb-6">Cada activaci√≥n V11 FINAL suma 3+ metros</p>
                        <button id="modoUnJugador" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg w-full transition-colors">
                            Comenzar Solo V11 FINAL
                        </button>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-lg p-8 hover:shadow-xl transition-shadow">
                        <div class="text-6xl mb-4">
                            <i class="fas fa-users text-green-600"></i>
                        </div>
                        <h3 class="text-xl font-semibold mb-4">Multijugador V11 FINAL</h3>
                        <p class="text-gray-600 mb-6">Compet√≠ contra un rival IA V11 FINAL en tiempo real</p>
                        <p class="text-xs text-gray-500 mb-6">¬°Pedale√° m√°s r√°pido V11 FINAL para ganar!</p>
                        <button id="modoMultijugador" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg w-full transition-colors">
                            Competir V11 FINAL
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- P√°gina de Juego Un Jugador V11 FINAL -->
        <div id="juegoUnJugador" class="page hidden">
            <div class="max-w-4xl mx-auto">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-800 mb-4 v11-title">Modo Individual V11 FINAL</h1>
                    <p class="text-lg text-gray-600" id="gameInstructions">¬°Activa el sensor HW-511 V11 FINAL f√≠sico para hacer circular la bici!</p>
                    <div class="flex items-center justify-center gap-4 mt-4">
                        <div class="v11-badge" id="gameConnectionBadge">
                            Sensor HW-511 V11 FINAL Activo
                        </div>
                        <div id="gameSensorStatus" class="flex items-center gap-2 hidden">
                            <div id="gameLedDot" class="w-2 h-2 rounded-full bg-gray-400"></div>
                            <span class="text-xs">LED V11 FINAL: <span id="gameLedText">OFF</span></span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 text-center">
                        <div>
                            <div id="cuentaRegresiva" class="text-4xl font-bold text-red-600 mb-2">60</div>
                            <p class="text-gray-600">Segundos</p>
                        </div>
                        <div>
                            <div id="velocidad" class="text-4xl font-bold text-blue-600 mb-2">0</div>
                            <p class="text-gray-600">km/h</p>
                        </div>
                        <div>
                            <div id="distancia" class="text-4xl font-bold text-green-600 mb-2">0</div>
                            <p class="text-gray-600">metros</p>
                        </div>
                        <div>
                            <div id="clicksGame" class="text-4xl font-bold text-purple-600 mb-2">0</div>
                            <p class="text-gray-600">Clicks V11 FINAL</p>
                        </div>
                    </div>
                    
                    <div class="speed-indicator h-4 rounded-full mb-8">
                        <div id="speedBar" class="h-full bg-white rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>

                    <p class="text-center text-sm text-gray-600 mb-8">
                        üéÆ JUEGO V11 FINAL ACTIVO - Activa el sensor f√≠sico para avanzar | Clicks: <span id="gameClickCount">0</span> | Total: <span id="gameTotalClicks">0</span>
                    </p>
                    
                    <div class="text-center">
                        <div id="manubrio" class="inline-block text-8xl cursor-pointer select-none hover:scale-110 transition-transform">
                            <i class="fas fa-bicycle"></i>
                        </div>
                        <div id="pedalAnimation" class="text-4xl mt-4">
                            <i class="fas fa-circle-notch"></i>
                        </div>
                        <p class="mt-4 text-gray-600" id="pedalInstructions">
                            üî• ¬°Activa el sensor infrarrojo HW-511 V11 FINAL en pin D2!
                        </p>
                        <p class="text-sm text-blue-600">Cada activaci√≥n V11 FINAL suma 3+ metros (m√°s bonus por velocidad)</p>

                        <!-- Estado del sensor durante el juego V11 FINAL -->
                        <div id="gameSensorInfo" class="mt-4 p-3 bg-blue-100 rounded text-sm hidden">
                            <strong>Estado del sensor V11 FINAL:</strong> <span id="gameSensorStatusText">Esperando...</span>
                            <div id="gameLastClickTime" class="text-xs"></div>
                        </div>

                        <!-- Botones de control durante el juego V11 FINAL -->
                        <div id="gameControlButtons" class="grid grid-cols-2 gap-2 mt-4 hidden">
                            <button id="gameTestSensor" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded transition-colors">
                                üß™ Probar Sensor V11 FINAL
                            </button>
                            <button id="gameRequestStatus" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded transition-colors">
                                üìä Estado Sensor V11 FINAL
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- P√°gina de Juego Multijugador V11 FINAL -->
        <div id="juegoMultijugador" class="page hidden">
            <div class="max-w-6xl mx-auto">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-800 mb-4 v11-title">Modo Competencia V11 FINAL</h1>
                    <p class="text-lg text-gray-600" id="multiInstructions">¬°Activa el sensor HW-511 V11 FINAL para ganar!</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                    <!-- Jugador Actual V11 FINAL -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-semibold text-center mb-4 text-blue-600">Tu Progreso V11 FINAL (Derecha)</h3>
                        <div class="text-center mb-6">
                            <div id="miVelocidad" class="text-3xl font-bold text-blue-600 mb-2">0 km/h</div>
                            <div id="miDistancia" class="text-2xl font-semibold text-green-600">0 m</div>
                        </div>
                        <div id="ciclistaPropio" class="text-center text-6xl bike-moving">
                            <i class="fas fa-biking"></i>
                        </div>
                        <div class="text-center mt-4">
                            <div class="v11-badge">Clicks V11 FINAL: <span id="multiClickCount">0</span></div>
                            <div id="multiSensorStatus" class="flex items-center justify-center gap-2 mt-2 hidden">
                                <div id="multiLedDot" class="w-2 h-2 rounded-full bg-gray-400"></div>
                                <span class="text-xs">LED V11 FINAL: <span id="multiLedText">OFF</span></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Rival V11 FINAL -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-semibold text-center mb-4 text-red-600">Rival IA V11 FINAL (Izquierda)</h3>
                        <div class="text-center mb-6">
                            <div id="rivalVelocidad" class="text-3xl font-bold text-red-600 mb-2">0 km/h</div>
                            <div id="distanciaRival" class="text-2xl font-semibold text-green-600">0 m</div>
                        </div>
                        <div id="ciclistaRival" class="text-center text-6xl cyclist-left">
                            <i class="fas fa-biking"></i>
                        </div>
                        <div class="text-center mt-4">
                            <div class="v11-badge">IA Inteligente V11 FINAL</div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-lg p-8">
                    <div class="text-center mb-6">
                        <div id="cuentaRegresivaMulti" class="text-5xl font-bold text-red-600 mb-2">60</div>
                        <p class="text-gray-600">Segundos restantes V11 FINAL</p>
                        <p class="text-sm text-blue-600 mt-2">üî• ¬°Activa el sensor f√≠sico V11 FINAL para avanzar!</p>
                    </div>
                    
                    <div class="text-center">
                        <div id="manubrioMulti" class="inline-block text-8xl cursor-pointer select-none hover:scale-110 transition-transform">
                            <i class="fas fa-bicycle"></i>
                        </div>
                        <div id="pedalAnimationMulti" class="text-4xl mt-4">
                            <i class="fas fa-circle-notch"></i>
                        </div>

                        <!-- Botones de control multijugador V11 FINAL -->
                        <div id="multiControlButtons" class="grid grid-cols-2 gap-2 mt-4 hidden">
                            <button id="multiTestSensor" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded transition-colors">
                                üß™ Probar Sensor V11 FINAL
                            </button>
                            <button id="multiRequestStatus" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded transition-colors">
                                üìä Estado Sensor V11 FINAL
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- P√°gina de Resultados V11 FINAL -->
        <div id="resultados" class="page hidden">
            <div class="max-w-2xl mx-auto text-center">
                <h1 class="text-4xl font-bold text-gray-800 mb-8 v11-title">¬°Fin del Juego V11 FINAL!</h1>
                
                <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
                    <div class="text-6xl mb-6">
                        <i id="resultIcon" class="fas fa-trophy text-yellow-500"></i>
                    </div>
                    
                    <h2 id="resultTitle" class="text-2xl font-semibold mb-6">Tu rendimiento V11 FINAL:</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="text-center">
                            <div id="distanciaFinal" class="text-3xl font-bold text-green-600 mb-2">0 m</div>
                            <p class="text-gray-600">Distancia Final V11 FINAL</p>
                        </div>
                        <div class="text-center">
                            <div id="velocidadMedia" class="text-3xl font-bold text-blue-600 mb-2">0 km/h</div>
                            <p class="text-gray-600">Velocidad Media V11 FINAL</p>
                        </div>
                        <div class="text-center">
                            <div id="clicksFinal" class="text-3xl font-bold text-purple-600 mb-2">0</div>
                            <p class="text-gray-600" id="clicksDescription">Activaciones del Sensor V11 FINAL</p>
                        </div>
                    </div>

                    <div class="text-center p-4 bg-blue-50 rounded-lg mb-6">
                        <div id="totalClicksFinal" class="text-2xl font-bold text-blue-800 mb-2">0</div>
                        <p class="text-blue-600">Total de clicks V11 FINAL detectados en toda la sesi√≥n</p>
                    </div>
                    
                    <div id="multiplayerResults" class="hidden mb-6">
                        <h3 class="text-xl font-semibold mb-4">Resultado de la Competencia V11 FINAL</h3>
                        <div id="winnerMessage" class="text-lg font-medium mb-4"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-2 border rounded">
                                T√∫ V11 FINAL: <span id="finalPlayerDistance">0</span>m
                            </div>
                            <div class="p-2 border rounded">
                                Rival V11 FINAL: <span id="finalRivalDistance">0</span>m
                            </div>
                        </div>
                    </div>
                    
                    <button id="volverInicio" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                        <i class="fas fa-home mr-2"></i>
                        Volver al Inicio V11 FINAL
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== VERSI√ìN 11 FINAL - JAVASCRIPT SIN BLOQUEOS =====
        console.log("üöÄ BIKE RACE GAME VERSI√ìN 11 FINAL CARGADA");
        
        // Mostrar timestamp de build
        document.getElementById('buildTime').textContent = new Date().toISOString();
        
        // Estado global de la aplicaci√≥n V11 FINAL
        const gameState = {
            nodemcuDetectado: false,
            jugador: 1,
            velocidad: 0,
            distancia: 0,
            velocidadMedia: 0,
            distanciaFinal: 0,
            distanciaRival: 0,
            rivalVelocidad: 0,
            gameTimer: null,
            gameActive: false,
            connectionMethod: null,
            isMultiplayer: false,
            clickCount: 0,
            lastClickTime: 0,
            rivalClickCount: 0,
            totalClicks: 0,
            isConnected: false,
            serialPort: null,
            writer: null,
            readingInterval: null,
            connectionLog: [],
            rawSerialData: [],
            ledStatus: false,
            sensorStatus: "Esperando...",
            lastSensorTime: 0
        };

        // ===== FUNCIONES DE LOG V11 FINAL =====
        function addConnectionLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `${timestamp}: ${message}`;
            gameState.connectionLog.push(logMessage);
            
            // Mantener solo los √∫ltimos 5 logs
            if (gameState.connectionLog.length > 5) {
                gameState.connectionLog.shift();
            }
            
            updateConnectionLogDisplay();
            console.log(`V11 FINAL: ${logMessage}`);
        }

        function updateConnectionLogDisplay() {
            const logList = document.getElementById('connectionLogList');
            const logDisplay = document.getElementById('connectionLogDisplay');
            
            if (gameState.connectionLog.length > 0) {
                logDisplay.classList.remove('hidden');
                logList.innerHTML = gameState.connectionLog.map(log => 
                    `<div class="text-xs text-blue-800 mb-1">${log}</div>`
                ).join('');
            }
        }

        // ===== FUNCIONES DE UTILIDAD V11 FINAL =====
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.remove('hidden');
            document.getElementById(pageId).classList.add('active');
        }

        function updateConnectionStatus(status, isConnected = false) {
            const statusElement = document.getElementById('estadoConexion');
            const connectionStatusLi = document.getElementById('connectionStatusLi');
            const commandStatusLi = document.getElementById('commandStatusLi');
            
            if (isConnected) {
                statusElement.innerHTML = `
                    <i class="fas fa-check-circle text-green-600"></i>
                    <span class="text-green-800 ml-2">${status}</span>
                `;
                statusElement.className = 'mb-6 p-4 rounded-lg bg-green-50 border border-green-200';
                connectionStatusLi.innerHTML = '‚Ä¢ ‚úÖ Conexi√≥n: OK - Lectura peri√≥dica V11 FINAL activa';
                commandStatusLi.innerHTML = '‚Ä¢ ‚úÖ Env√≠o de comandos: Funciona (bot√≥n Probar V11 FINAL)';
            } else {
                statusElement.innerHTML = `
                    <div class="connection-pulse">
                        <i class="fas fa-exclamation-triangle text-blue-600"></i>
                        <span class="text-blue-800 ml-2">${status}</span>
                    </div>
                `;
                statusElement.className = 'mb-6 p-4 rounded-lg bg-blue-50 border border-blue-200';
                connectionStatusLi.innerHTML = '‚Ä¢ ‚ùå Conexi√≥n: No conectado';
                commandStatusLi.innerHTML = '‚Ä¢ ‚ùå Env√≠o de comandos: N/A';
            }
        }

        function calculateSpeed(clickInterval) {
            if (clickInterval < 200) return 50;
            if (clickInterval < 500) return 35;
            if (clickInterval < 1000) return 25;
            if (clickInterval < 2000) return 15;
            return 10;
        }

        // ===== FUNCIONES DE CONEXI√ìN SERIE V11 FINAL =====
        async function checkSerialSupport() {
            try {
                if (!('serial' in navigator)) {
                    updateConnectionStatus('‚ùå Web Serial API no disponible. Usa Chrome/Edge en una ventana normal.');
                    addConnectionLog('Web Serial API no disponible - V11 FINAL');
                    return false;
                }

                if (window.self !== window.top) {
                    updateConnectionStatus('‚ö†Ô∏è Web Serial API bloqueada en iframe. Abre la aplicaci√≥n en una ventana nueva.');
                    addConnectionLog('Detectado iframe - permisos restringidos - V11 FINAL');
                    return false;
                }

                updateConnectionStatus('‚úÖ Web Serial API disponible. Listo para conectar NodeMCU V11 FINAL.');
                addConnectionLog('Web Serial API disponible - V11 FINAL lista');
                return true;
            } catch (error) {
                console.error('Error verificando soporte V11 FINAL:', error);
                updateConnectionStatus('‚ùå Error verificando compatibilidad. Usa modo alternativo.');
                addConnectionLog(`Error V11 FINAL: ${error}`);
                return false;
            }
        }

        async function connectToNodeMCU() {
            const serialSupported = await checkSerialSupport();
            
            if (!serialSupported) {
                updateConnectionStatus('‚ö†Ô∏è Web Serial API no disponible. Usando modo simulado V11 FINAL.');
                addConnectionLog('Fallback a modo simulado V11 FINAL');
                startSimulatedConnection();
                return;
            }

            updateConnectionStatus('üîå Selecciona el puerto del NodeMCU en el di√°logo... (V11 FINAL)');
            addConnectionLog('Solicitando puerto serie V11 FINAL...');

            try {
                const port = await navigator.serial.requestPort();
                addConnectionLog('Puerto seleccionado V11 FINAL, abriendo conexi√≥n...');

                await port.open({
                    baudRate: 115200,
                    dataBits: 8,
                    stopBits: 1,
                    parity: 'none',
                    flowControl: 'none'
                });

                addConnectionLog('‚úÖ Puerto abierto exitosamente V11 FINAL');
                gameState.serialPort = port;
                gameState.isConnected = true;
                gameState.nodemcuDetectado = true;
                gameState.connectionMethod = 'usb';
                
                updateConnectionStatus('üéâ ¬°NodeMCU V11 FINAL conectado! Configurando comunicaci√≥n...', true);
                showConnectedElements();

                // Configurar writer
                const textEncoder = new TextEncoderStream();
                textEncoder.readable.pipeTo(port.writable);
                const writer = textEncoder.writable.getWriter();
                gameState.writer = writer;

                // Iniciar lectura peri√≥dica (NO BLOQUEANTE)
                startPeriodicReading(port);

                // Enviar comando de inicializaci√≥n
                setTimeout(async () => {
                    try {
                        await writer.write('INIT\n');
                        addConnectionLog('Comando INIT V11 FINAL enviado');
                        updateConnectionStatus('üöÄ ¬°NodeMCU V11 FINAL listo! Esperando datos del sensor...', true);
                        updateSensorStatus('Sensor V11 FINAL listo');
                    } catch (e) {
                        addConnectionLog('Error enviando INIT V11 FINAL');
                    }
                }, 1000);

                // Ir a selecci√≥n de modo
                setTimeout(() => {
                    showPage('seleccionModo');
                    updateModeSelectionPage();
                }, 3000);

            } catch (error) {
                console.error('Error conectando V11 FINAL:', error);
                addConnectionLog(`Error V11 FINAL: ${error.message}`);

                if (error.name === 'NotFoundError') {
                    updateConnectionStatus('‚ùå No se seleccion√≥ ning√∫n dispositivo V11 FINAL.');
                } else {
                    updateConnectionStatus('‚ùå Error de conexi√≥n V11 FINAL. Usando modo simulado.');
                    setTimeout(() => {
                        startSimulatedConnection();
                    }, 2000);
                }
            }
        }

        // LECTURA PERI√ìDICA NO BLOQUEANTE V11 FINAL
        function startPeriodicReading(port) {
            addConnectionLog('üîç Iniciando lectura peri√≥dica V11 FINAL...');
            updateSensorStatus('Escuchando sensor V11 FINAL...');

            let buffer = '';

            const readChunk = async () => {
                try {
                    if (!port.readable) return;

                    const reader = port.readable.getReader();
                    const decoder = new TextDecoder();

                    try {
                        // Leer con timeout muy corto
                        const { value, done } = await Promise.race([
                            reader.read(),
                            new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 100))
                        ]);

                        if (done) {
                            addConnectionLog('Lectura V11 FINAL terminada');
                            return;
                        }

                        if (value) {
                            const text = decoder.decode(value, { stream: true });
                            buffer += text;

                            // Procesar l√≠neas completas
                            const lines = buffer.split(/[\r\n]+/);
                            buffer = lines.pop() || '';

                            for (const line of lines) {
                                const cleanLine = line.trim();
                                if (cleanLine) {
                                    processSerialData(cleanLine);
                                }
                            }
                        }
                    } finally {
                        reader.releaseLock();
                    }
                } catch (error) {
                    if (error.message !== 'timeout') {
                        console.error('Error leyendo V11 FINAL:', error);
                        addConnectionLog(`Error leyendo V11 FINAL: ${error.message}`);
                    }
                }
            };

            // Leer cada 200ms (NO BLOQUEANTE)
            gameState.readingInterval = setInterval(readChunk, 200);
        }

        function processSerialData(data) {
            // Agregar a datos raw
            gameState.rawSerialData.push(data);
            if (gameState.rawSerialData.length > 10) {
                gameState.rawSerialData.shift();
            }
            updateRawDataDisplay();

            // Mostrar √∫ltimo dato
            updateSensorDataDisplay(data);
            addConnectionLog(`üì° V11 FINAL Recibido: "${data}"`);

            const lowerData = data.toLowerCase();

            if (lowerData === 'click' || lowerData === 'sensor_activated' || data === '1') {
                addConnectionLog('üö¥‚Äç‚ôÇÔ∏è ¬°SENSOR F√çSICO V11 FINAL ACTIVADO!');
                updateSensorStatus('¬°Sensor V11 FINAL activado!');
                updateLastClickTime();
                setLedStatus(true);
                setTimeout(() => {
                    setLedStatus(false);
                    updateSensorStatus('Esperando sensor V11 FINAL...');
                }, 300);
                handleSensorActivation();
            } else if (lowerData.includes('listo') || lowerData.includes('ready') || lowerData.includes('inicializado')) {
                addConnectionLog('‚úÖ NodeMCU V11 FINAL inicializado correctamente');
                updateConnectionStatus('üéâ ¬°NodeMCU V11 FINAL listo! Sensor HW-511 funcionando.', true);
                updateSensorStatus('Sensor V11 FINAL listo');
            } else if (lowerData.includes('led_on')) {
                setLedStatus(true);
                addConnectionLog('üí° LED V11 FINAL encendido');
            } else if (lowerData.includes('led_off')) {
                setLedStatus(false);
                addConnectionLog('üí° LED V11 FINAL apagado');
            } else if (lowerData.includes('prueba') || lowerData.includes('test')) {
                addConnectionLog('üß™ Comando de prueba V11 FINAL recibido por NodeMCU');
            }
        }

        function handleSensorActivation() {
            const currentTime = Date.now();
            const timeDiff = currentTime - gameState.lastSensorTime;

            addConnectionLog(`‚ö° V11 FINAL PROCESANDO CLICK - Intervalo: ${timeDiff}ms`);

            // Activar animaci√≥n de pedaleo
            activatePedalAnimation();

            // SIEMPRE incrementar el contador total de clicks
            gameState.totalClicks++;
            updateTotalClicksDisplay();

            // Si el juego est√° activo, calcular velocidad y distancia
            if (gameState.gameActive) {
                gameState.velocidad = calculateSpeed(timeDiff);
                // Cada click agrega distancia base + bonus por velocidad
                const distanceIncrement = 3 + gameState.velocidad / 8; // 3 metros base + bonus
                gameState.distancia += distanceIncrement;
                gameState.clickCount++;

                addConnectionLog(
                    `üèÉ‚Äç‚ôÇÔ∏è V11 FINAL JUEGO ACTIVO - Velocidad: ${Math.round(gameState.velocidad)}km/h | Distancia: +${Math.round(distanceIncrement)}m | Total: ${Math.round(gameState.distancia)}m`
                );

                updateGameStats();
            } else {
                addConnectionLog(`üìä V11 FINAL Click registrado (juego no activo) - Total clicks: ${gameState.totalClicks}`);
            }

            gameState.lastSensorTime = currentTime;
            updateClickStatus();
        }

        // ===== FUNCIONES DE INTERFAZ V11 FINAL =====
        function showConnectedElements() {
            document.getElementById('sensorStatus').classList.remove('hidden');
            document.getElementById('controlButtons').classList.remove('hidden');
            document.getElementById('detectarNodeMCU').textContent = 'NodeMCU V11 FINAL Conectado';
            document.getElementById('detectarNodeMCU').disabled = true;
        }

        function updateSensorStatus(status) {
            gameState.sensorStatus = status;
            const elements = [
                'sensorStatusText',
                'sensorStatusGameText', 
                'gameSensorStatusText'
            ];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.textContent = status;
            });

            // Actualizar indicador visual
            const indicator = document.getElementById('sensorIndicator');
            if (indicator) {
                if (status.includes('activado')) {
                    indicator.className = 'p-3 rounded-lg border bg-green-100 border-green-300';
                } else {
                    indicator.className = 'p-3 rounded-lg border bg-blue-100 border-blue-300';
                }
            }
        }

        function setLedStatus(status) {
            gameState.ledStatus = status;
            const dots = [
                'ledDot',
                'ledStatusGame',
                'gameLedDot',
                'multiLedDot'
            ];
            
            const texts = [
                'ledStatusText',
                'ledStatusGameText',
                'gameLedText',
                'multiLedText'
            ];

            dots.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    if (status) {
                        element.className = 'w-2 h-2 rounded-full mx-auto mb-1 bg-green-500 animate-pulse';
                    } else {
                        element.className = 'w-2 h-2 rounded-full mx-auto mb-1 bg-gray-400';
                    }
                }
            });

            texts.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = status ? 'ON' : 'OFF';
                }
            });

            // Actualizar indicador LED principal
            const ledIndicator = document.getElementById('ledIndicator');
            if (ledIndicator) {
                if (status) {
                    ledIndicator.className = 'p-3 rounded-lg border bg-green-100 border-green-300';
                } else {
                    ledIndicator.className = 'p-3 rounded-lg border bg-gray-100 border-gray-300';
                }
            }
        }

        function updateTotalClicksDisplay() {
            const elements = [
                'totalClicks',
                'totalClicksCount',
                'gameTotalClicks',
                'totalClicksFinal'
            ];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.textContent = gameState.totalClicks;
            });

            // Mostrar contador si hay clicks
            if (gameState.totalClicks > 0) {
                const counter = document.getElementById('clickCounter');
                if (counter) counter.classList.remove('hidden');
                
                const display = document.getElementById('totalClicksDisplay');
                if (display) display.classList.remove('hidden');
            }
        }

        function updateLastClickTime() {
            const timeString = new Date().toLocaleTimeString();
            const element = document.getElementById('lastClickTime');
            if (element) {
                element.textContent = `√öltimo: ${timeString}`;
            }
            
            const gameElement = document.getElementById('gameLastClickTime');
            if (gameElement) {
                gameElement.textContent = `√öltimo click V11 FINAL: ${timeString}`;
            }
        }

        function updateSensorDataDisplay(data) {
            const codeElement = document.getElementById('sensorDataCode');
            const displayElement = document.getElementById('sensorDataDisplay');
            
            if (codeElement && displayElement) {
                codeElement.textContent = data;
                if (data.toLowerCase() === 'click') {
                    codeElement.className = 'text-sm font-mono font-bold text-green-600 animate-pulse';
                } else {
                    codeElement.className = 'text-sm font-mono font-bold text-gray-600';
                }
                displayElement.classList.remove('hidden');
            }
        }

        function updateRawDataDisplay() {
            const listElement = document.getElementById('rawDataList');
            const displayElement = document.getElementById('rawDataLog');
            
            if (listElement && displayElement && gameState.rawSerialData.length > 0) {
                listElement.innerHTML = gameState.rawSerialData.map((data, index) => {
                    const className = data.toLowerCase() === 'click' ? 'text-green-600 font-bold' : 'text-gray-600';
                    return `<div class="text-xs font-mono">
                        <span class="text-gray-400">${index + 1}:</span>
                        <span class="${className}">${data}</span>
                    </div>`;
                }).join('');
                displayElement.classList.remove('hidden');
            }
        }

        function updateClickStatus() {
            const clickStatusLi = document.getElementById('clickStatusLi');
            if (clickStatusLi) {
                if (gameState.totalClicks > 0) {
                    clickStatusLi.innerHTML = '‚Ä¢ ‚úÖ Recepci√≥n de "click": OK V11 FINAL';
                } else {
                    clickStatusLi.innerHTML = '‚Ä¢ üîç Recepci√≥n de "click": Verificar sensor';
                }
            }
        }

        function activatePedalAnimation() {
            const elements = [
                'manubrio',
                'manubrioMulti'
            ];
            
            const pedalElements = [
                'pedalAnimation',
                'pedalAnimationMulti'
            ];

            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.classList.add('handlebar-active');
                    element.style.filter = 'drop-shadow(0 0 20px #3b82f6)';
                    element.style.transform = 'scale(1.1)';
                    
                    setTimeout(() => {
                        element.classList.remove('handlebar-active');
                        element.style.filter = 'none';
                        element.style.transform = 'scale(1)';
                    }, 500);
                }
            });

            pedalElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.classList.add('pedaling');
                    setTimeout(() => {
                        element.classList.remove('pedaling');
                    }, 500);
                }
            });
        }

        // ===== FUNCIONES DE CONTROL V11 FINAL =====
        async function testSensor() {
            if (gameState.writer) {
                try {
                    await gameState.writer.write('TEST_SENSOR\n');
                    addConnectionLog('üß™ V11 FINAL Comando de prueba del sensor enviado');
                    updateSensorStatus('Enviando prueba V11 FINAL...');
                } catch (error) {
                    addConnectionLog('‚ùå V11 FINAL Error enviando comando de prueba');
                }
            }
        }

        async function requestSensorStatus() {
            if (gameState.writer) {
                try {
                    await gameState.writer.write('STATUS\n');
                    addConnectionLog('üìä V11 FINAL Solicitando estado del sensor');
                } catch (error) {
                    addConnectionLog('‚ùå V11 FINAL Error solicitando estado');
                }
            }
        }

        function startSimulatedConnection() {
            updateConnectionStatus('üéÆ Modo simulado V11 FINAL activado - Sensor virtual conectado', true);
            gameState.isConnected = true;
            gameState.nodemcuDetectado = true;
            gameState.connectionMethod = 'simulated';
            addConnectionLog('Modo simulado V11 FINAL iniciado');

            setTimeout(() => {
                showPage('seleccionModo');
                updateModeSelectionPage();
            }, 1500);
        }

        async function disconnectNodeMCU() {
            try {
                // Limpiar interval de lectura
                if (gameState.readingInterval) {
                    clearInterval(gameState.readingInterval);
                    addConnectionLog('V11 FINAL Interval de lectura detenido');
                }

                if (gameState.writer) {
                    await gameState.writer.close();
                    addConnectionLog('V11 FINAL Writer cerrado');
                }

                if (gameState.serialPort) {
                    await gameState.serialPort.close();
                    addConnectionLog('V11 FINAL Puerto serie cerrado');
                }

                // Reset state
                gameState.isConnected = false;
                gameState.nodemcuDetectado = false;
                gameState.serialPort = null;
                gameState.writer = null;
                gameState.readingInterval = null;
                gameState.rawSerialData = [];
                gameState.ledStatus = false;
                gameState.sensorStatus = 'V11 FINAL Desconectado';

                updateConnectionStatus('üîå NodeMCU V11 FINAL desconectado');
                hideConnectedElements();
                updateSensorStatus('V11 FINAL Desconectado');
                setLedStatus(false);

            } catch (error) {
                console.error('Error desconectando V11 FINAL:', error);
                addConnectionLog(`V11 FINAL Error desconectando: ${error}`);
            }
        }

        function hideConnectedElements() {
            document.getElementById('sensorStatus').classList.add('hidden');
            document.getElementById('controlButtons').classList.add('hidden');
            document.getElementById('sensorDataDisplay').classList.add('hidden');
            document.getElementById('rawDataLog').classList.add('hidden');
            document.getElementById('clickCounter').classList.add('hidden');
            document.getElementById('detectarNodeMCU').textContent = 'Conectar NodeMCU V11 FINAL por USB';
            document.getElementById('detectarNodeMCU').disabled = false;
        }

        // ===== FUNCIONES DE JUEGO V11 FINAL =====
        function updateModeSelectionPage() {
            const badge = document.getElementById('connectionBadge');
            if (badge) {
                badge.textContent = `Conectado V11 FINAL via ${gameState.connectionMethod === 'usb' ? 'USB Real' : 'Modo Manual'}`;
            }

            const description = document.getElementById('singlePlayerDescription');
            if (description) {
                if (gameState.connectionMethod === 'usb') {
                    description.textContent = 'Activa el sensor HW-511 V11 FINAL para pedalear';
                } else {
                    description.textContent = 'Haz clic V11 FINAL para pedalear';
                }
            }

            // Mostrar estado del sensor si est√° conectado por USB
            if (gameState.connectionMethod === 'usb') {
                const sensorStatusGame = document.getElementById('sensorStatusGame');
                if (sensorStatusGame) sensorStatusGame.classList.remove('hidden');
                
                updateSensorStatus(gameState.sensorStatus);
                setLedStatus(gameState.ledStatus);
            }

            updateTotalClicksDisplay();
        }

        function startGame(isMultiplayer) {
            gameState.gameActive = true;
            gameState.isMultiplayer = isMultiplayer;
            gameState.velocidad = 0;
            gameState.distancia = 0;
            gameState.distanciaRival = 0;
            gameState.clickCount = 0;
            gameState.lastSensorTime = Date.now();

            const timeLeft = 60;
            updateGameTimer(timeLeft);

            showPage(isMultiplayer ? 'juegoMultijugador' : 'juegoUnJugador');
            updateGamePage(isMultiplayer);
            
            addConnectionLog(`üéÆ V11 FINAL JUEGO INICIADO - Modo: ${isMultiplayer ? 'Multijugador' : 'Individual'}`);
            addConnectionLog('üî• V11 FINAL ¬°Activa el sensor f√≠sico para hacer avanzar la bici!');

            // Iniciar timer del juego
            let currentTime = timeLeft;
            gameState.gameTimer = setInterval(() => {
                currentTime--;
                updateGameTimer(currentTime);
                
                if (currentTime <= 0) {
                    endGame();
                }
            }, 1000);

            // Si es multijugador, simular rival
            if (isMultiplayer) {
                gameState.rivalTimer = setInterval(() => {
                    gameState.rivalVelocidad = Math.random() * 40;
                    const rivalDistanceIncrement = gameState.rivalVelocidad / 3.6;
                    gameState.distanciaRival += rivalDistanceIncrement;
                    updateRivalStats();
                }, 1000);
            }
        }

        function updateGamePage(isMultiplayer) {
            // Actualizar instrucciones
            const instructions = document.getElementById(isMultiplayer ? 'multiInstructions' : 'gameInstructions');
            if (instructions) {
                if (gameState.connectionMethod === 'usb') {
                    instructions.textContent = `¬°Activa el sensor HW-511 V11 FINAL ${isMultiplayer ? 'para ganar' : 'f√≠sico para hacer circular la bici'}!`;
                } else {
                    instructions.textContent = `¬°Haz clic V11 FINAL ${isMultiplayer ? 'para ganar' : 'para pedalear'}!`;
                }
            }

            // Actualizar badge de conexi√≥n
            const badge = document.getElementById('gameConnectionBadge');
            if (badge) {
                badge.textContent = gameState.connectionMethod === 'usb' ? 
                    'Sensor HW-511 V11 FINAL Activo' : 'Modo Manual V11 FINAL';
            }

            // Actualizar instrucciones de pedaleo
            const pedalInstructions = document.getElementById('pedalInstructions');
            if (pedalInstructions) {
                if (gameState.connectionMethod === 'usb') {
                    pedalInstructions.textContent = 'üî• ¬°Activa el sensor infrarrojo HW-511 V11 FINAL en pin D2!';
                } else {
                    pedalInstructions.textContent = 'Haz clic V11 FINAL en la bicicleta para pedalear';
                }
            }

            // Mostrar controles del sensor si est√° conectado por USB
            if (gameState.connectionMethod === 'usb') {
                const gameControls = document.getElementById('gameControlButtons');
                const multiControls = document.getElementById('multiControlButtons');
                const gameSensorInfo = document.getElementById('gameSensorInfo');
                const gameSensorStatus = document.getElementById('gameSensorStatus');
                const multiSensorStatus = document.getElementById('multiSensorStatus');
                
                if (gameControls) gameControls.classList.remove('hidden');
                if (multiControls) multiControls.classList.remove('hidden');
                if (gameSensorInfo) gameSensorInfo.classList.remove('hidden');
                if (gameSensorStatus) gameSensorStatus.classList.remove('hidden');
                if (multiSensorStatus) multiSensorStatus.classList.remove('hidden');
                
                updateSensorStatus(gameState.sensorStatus);
                setLedStatus(gameState.ledStatus);
            }

            updateGameStats();
        }

        function updateGameTimer(time) {
            const elements = [
                'cuentaRegresiva',
                'cuentaRegresivaMulti'
            ];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.textContent = time;
            });
        }

        function updateGameStats() {
            // Actualizar estad√≠sticas del juego individual
            document.getElementById('velocidad').textContent = Math.round(gameState.velocidad);
            document.getElementById('distancia').textContent = Math.round(gameState.distancia);
            document.getElementById('clicksGame').textContent = gameState.clickCount;
            document.getElementById('gameClickCount').textContent = gameState.clickCount;
            document.getElementById('gameTotalClicks').textContent = gameState.totalClicks;

            // Actualizar estad√≠sticas multijugador
            document.getElementById('miVelocidad').textContent = `${Math.round(gameState.velocidad)} km/h`;
            document.getElementById('miDistancia').textContent = `${Math.round(gameState.distancia)} m`;
            document.getElementById('multiClickCount').textContent = gameState.clickCount;

            // Actualizar barra de velocidad
            const speedPercentage = Math.min(100, (gameState.velocidad / 50) * 100);
            document.getElementById('speedBar').style.width = `${speedPercentage}%`;

            // Animar ciclistas
            const ciclistaPropio = document.getElementById('ciclistaPropio');
            if (ciclistaPropio) {
                if (gameState.velocidad > 10) {
                    ciclistaPropio.classList.add('bike-moving');
                } else {
                    ciclistaPropio.classList.remove('bike-moving');
                }
            }
        }

        function updateRivalStats() {
            document.getElementById('rivalVelocidad').textContent = `${Math.round(gameState.rivalVelocidad)} km/h`;
            document.getElementById('distanciaRival').textContent = `${Math.round(gameState.distanciaRival)} m`;

            // Animar ciclista rival
            const ciclistaRival = document.getElementById('ciclistaRival');
            if (ciclistaRival) {
                if (gameState.rivalVelocidad > 10) {
                    ciclistaRival.classList.add('bike-moving');
                } else {
                    ciclistaRival.classList.remove('bike-moving');
                }
            }
        }

        function endGame() {
            gameState.gameActive = false;
            if (gameState.gameTimer) clearInterval(gameState.gameTimer);
            if (gameState.rivalTimer) clearInterval(gameState.rivalTimer);
            addConnectionLog('üèÅ V11 FINAL Juego terminado');

            gameState.distanciaFinal = Math.round(gameState.distancia);
            gameState.velocidadMedia = gameState.clickCount > 0 ? Math.round((gameState.distancia / 60) * 3.6) : 0;

            showPage('resultados');
            updateResultsPage();
        }

        function updateResultsPage() {
            document.getElementById('distanciaFinal').textContent = `${gameState.distanciaFinal} m`;
            document.getElementById('velocidadMedia').textContent = `${gameState.velocidadMedia} km/h`;
            document.getElementById('clicksFinal').textContent = gameState.clickCount;
            document.getElementById('totalClicksFinal').textContent = gameState.totalClicks;

            // Actualizar descripci√≥n de clicks
            const clicksDescription = document.getElementById('clicksDescription');
            if (clicksDescription) {
                clicksDescription.textContent = gameState.connectionMethod === 'usb' ? 
                    'Activaciones del Sensor V11 FINAL' : 'Clicks Manuales V11 FINAL';
            }

            if (gameState.isMultiplayer) {
                const multiResults = document.getElementById('multiplayerResults');
                const winnerMessage = document.getElementById('winnerMessage');
                const resultIcon = document.getElementById('resultIcon');
                const resultTitle = document.getElementById('resultTitle');
                
                multiResults.classList.remove('hidden');
                document.getElementById('finalPlayerDistance').textContent = Math.round(gameState.distancia);
                document.getElementById('finalRivalDistance').textContent = Math.round(gameState.distanciaRival);

                if (gameState.distancia > gameState.distanciaRival) {
                    winnerMessage.innerHTML = '<span class="text-green-600">¬°Ganaste V11 FINAL!</span>';
                    resultIcon.className = 'fas fa-trophy text-yellow-500';
                    resultTitle.textContent = '¬°Ganaste V11 FINAL!';
                } else if (gameState.distancia < gameState.distanciaRival) {
                    winnerMessage.innerHTML = '<span class="text-red-600">Perdiste V11 FINAL</span>';
                    resultIcon.className = 'fas fa-medal text-gray-500';
                    resultTitle.textContent = 'Perdiste V11 FINAL';
                } else {
                    winnerMessage.innerHTML = '<span class="text-blue-600">¬°Empate V11 FINAL!</span>';
                    resultIcon.className = 'fas fa-handshake text-blue-500';
                    resultTitle.textContent = '¬°Empate V11 FINAL!';
                }
            }
        }

        function handleManualPedal() {
            addConnectionLog('üëÜ V11 FINAL Click manual procesado');
            handleSensorActivation();
        }

        // ===== EVENT LISTENERS V11 FINAL =====
        document.addEventListener('DOMContentLoaded', function() {
            addConnectionLog('üöÄ INICIANDO VERSI√ìN 11 FINAL - SIN BLOQUEOS');
            
            // Verificar soporte inicial
            checkSerialSupport();

            // Detectar NodeMCU
            document.getElementById('detectarNodeMCU').addEventListener('click', connectToNodeMCU);

            // M√©todos de conexi√≥n alternativos
            document.querySelectorAll('.connection-method').forEach(button => {
                button.addEventListener('click', function() {
                    gameState.connectionMethod = this.dataset.method;
                    gameState.nodemcuDetectado = true;
                    gameState.isConnected = true;
                    updateConnectionStatus(`Conectado V11 FINAL via ${this.dataset.method}`, true);
                    addConnectionLog(`Conexi√≥n V11 FINAL via ${this.dataset.method}`);
                    setTimeout(() => {
                        showPage('seleccionModo');
                        updateModeSelectionPage();
                    }, 1500);
                });
            });

            // Botones de control
            document.getElementById('testSensor').addEventListener('click', testSensor);
            document.getElementById('requestStatus').addEventListener('click', requestSensorStatus);
            document.getElementById('disconnectNodeMCU').addEventListener('click', disconnectNodeMCU);

            // Botones de control en juego
            document.getElementById('gameTestSensor').addEventListener('click', testSensor);
            document.getElementById('gameRequestStatus').addEventListener('click', requestSensorStatus);
            document.getElementById('multiTestSensor').addEventListener('click', testSensor);
            document.getElementById('multiRequestStatus').addEventListener('click', requestSensorStatus);

            // Selecci√≥n de modo
            document.getElementById('modoUnJugador').addEventListener('click', function() {
                startGame(false);
            });

            document.getElementById('modoMultijugador').addEventListener('click', function() {
                startGame(true);
            });

            // Controles de juego
            document.getElementById('manubrio').addEventListener('click', function() {
                if (gameState.connectionMethod === 'manual') {
                    handleManualPedal();
                }
            });

            document.getElementById('manubrioMulti').addEventListener('click', function() {
                if (gameState.connectionMethod === 'manual') {
                    handleManualPedal();
                }
            });

            // Volver al inicio
            document.getElementById('volverInicio').addEventListener('click', function() {
                showPage('inicio');
                gameState.nodemcuDetectado = false;
                gameState.gameActive = false;
                if (!gameState.isConnected) {
                    updateConnectionStatus('üöÄ VERSI√ìN 11 FINAL - Verificando compatibilidad...');
                    checkSerialSupport();
                }
            });

            // Controles de teclado
            document.addEventListener('keydown', function(e) {
                if (e.code === 'Space' && gameState.gameActive && gameState.connectionMethod === 'manual') {
                    e.preventDefault();
                    handleManualPedal();
                }
            });

            // Controles t√°ctiles
            document.addEventListener('touchstart', function(e) {
                if (gameState.gameActive && gameState.connectionMethod === 'manual' && 
                    (e.target.id === 'manubrio' || e.target.id === 'manubrioMulti')) {
                    handleManualPedal();
                }
            });
        });

        // Reducir velocidad gradualmente
        setInterval(() => {
            if (gameState.gameActive && gameState.velocidad > 0) {
                gameState.velocidad = Math.max(0, gameState.velocidad * 0.95);
                updateGameStats();
            }
        }, 1000);

        // Log inicial
        console.log('üöÄ BIKE RACE GAME VERSI√ìN 11 FINAL COMPLETAMENTE CARGADA');
        addConnectionLog('üéÆ Aplicaci√≥n V11 FINAL lista para usar');
    </script>
</body>
</html>
