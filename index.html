<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bike Race Sensor Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @keyframes pedal {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(180deg); }
        }
        
        @keyframes bike-move {
            0%, 100% { transform: translateX(0px); }
            50% { transform: translateX(5px); }
        }
        
        @keyframes handlebar-shake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-2deg); }
            75% { transform: rotate(2deg); }
        }
        
        .pedaling {
            animation: pedal 0.5s linear infinite;
        }
        
        .bike-moving {
            animation: bike-move 0.3s ease-in-out infinite;
        }
        
        .handlebar-active {
            animation: handlebar-shake 0.2s ease-in-out infinite;
        }
        
        .cyclist-left {
            transform: scaleX(-1);
        }
        
        .connection-pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .speed-indicator {
            background: linear-gradient(90deg, #10b981 0%, #f59e0b 50%, #ef4444 100%);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-green-50 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8">
        <!-- Página de Inicio -->
        <div id="inicio" class="page active">
            <div class="max-w-2xl mx-auto text-center">
                <h1 class="text-4xl font-bold text-gray-800 mb-8">
                    <i class="fas fa-bicycle text-blue-600"></i>
                    Bike Race Sensor Game
                </h1>
                
                <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
                    <h2 class="text-2xl font-semibold mb-4">Bienvenido al Juego de Pedaleo</h2>
                    <p class="text-gray-600 mb-6">
                        Conectá tu dispositivo NodeMCU con sensor infrarrojo HW-511 para comenzar.
                    </p>
                    
                    <div id="estadoConexion" class="mb-6 p-4 rounded-lg bg-yellow-50 border border-yellow-200">
                        <div class="connection-pulse">
                            <i class="fas fa-search text-yellow-600"></i>
                            <span class="text-yellow-800 ml-2">Esperando conexión del NodeMCU...</span>
                        </div>
                    </div>
                    
                    <button id="detectarNodeMCU" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                        <i class="fas fa-wifi mr-2"></i>
                        Detectar NodeMCU
                    </button>
                    
                    <div class="mt-6 text-sm text-gray-500">
                        <p>Conexión por: WiFi Direct, WiFi tradicional, Cable USB o táctil/clic</p>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold mb-4">Métodos de Conexión Alternativos</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button class="connection-method p-4 border-2 border-gray-200 rounded-lg hover:border-blue-400 transition-colors" data-method="wifi-direct">
                            <i class="fas fa-wifi text-2xl text-blue-600 mb-2"></i>
                            <p class="text-sm">WiFi Direct</p>
                        </button>
                        <button class="connection-method p-4 border-2 border-gray-200 rounded-lg hover:border-blue-400 transition-colors" data-method="wifi">
                            <i class="fas fa-network-wired text-2xl text-green-600 mb-2"></i>
                            <p class="text-sm">WiFi</p>
                        </button>
                        <button class="connection-method p-4 border-2 border-gray-200 rounded-lg hover:border-blue-400 transition-colors" data-method="usb">
                            <i class="fas fa-usb text-2xl text-purple-600 mb-2"></i>
                            <p class="text-sm">Cable USB</p>
                        </button>
                        <button class="connection-method p-4 border-2 border-gray-200 rounded-lg hover:border-blue-400 transition-colors" data-method="manual">
                            <i class="fas fa-hand-pointer text-2xl text-orange-600 mb-2"></i>
                            <p class="text-sm">Táctil/Clic</p>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Página de Selección de Modo -->
        <div id="seleccionModo" class="page hidden">
            <div class="max-w-2xl mx-auto text-center">
                <h1 class="text-3xl font-bold text-gray-800 mb-8">Seleccioná el modo de juego</h1>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="bg-white rounded-lg shadow-lg p-8 hover:shadow-xl transition-shadow">
                        <div class="text-6xl mb-4">
                            <i class="fas fa-user text-blue-600"></i>
                        </div>
                        <h3 class="text-xl font-semibold mb-4">Jugador Individual</h3>
                        <p class="text-gray-600 mb-6">Pedaleá contra el tiempo y mejorá tu récord personal</p>
                        <button id="modoUnJugador" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg w-full transition-colors">
                            Comenzar Solo
                        </button>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-lg p-8 hover:shadow-xl transition-shadow">
                        <div class="text-6xl mb-4">
                            <i class="fas fa-users text-green-600"></i>
                        </div>
                        <h3 class="text-xl font-semibold mb-4">Multijugador</h3>
                        <p class="text-gray-600 mb-6">Competí contra otro jugador en tiempo real</p>
                        <button id="modoMultijugador" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg w-full transition-colors">
                            Competir
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Página de Juego Un Jugador -->
        <div id="juegoUnJugador" class="page hidden">
            <div class="max-w-4xl mx-auto">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-800 mb-4">Modo Individual</h1>
                    <p class="text-lg text-gray-600">¡Pedaleá o hacé clic para avanzar. Tenés 1 minuto!</p>
                </div>
                
                <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="text-center">
                            <div id="cuentaRegresiva" class="text-4xl font-bold text-red-600 mb-2">60</div>
                            <p class="text-gray-600">Segundos</p>
                        </div>
                        <div class="text-center">
                            <div id="velocidad" class="text-4xl font-bold text-blue-600 mb-2">0</div>
                            <p class="text-gray-600">km/h</p>
                        </div>
                        <div class="text-center">
                            <div id="distancia" class="text-4xl font-bold text-green-600 mb-2">0</div>
                            <p class="text-gray-600">metros</p>
                        </div>
                    </div>
                    
                    <div class="speed-indicator h-4 rounded-full mb-8">
                        <div id="speedBar" class="h-full bg-white rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    
                    <div class="text-center">
                        <div id="manubrio" class="inline-block text-8xl cursor-pointer select-none hover:scale-110 transition-transform">
                            <i class="fas fa-bicycle"></i>
                        </div>
                        <div id="pedalAnimation" class="text-4xl mt-4">
                            <i class="fas fa-circle-notch"></i>
                        </div>
                        <p class="mt-4 text-gray-600">Hacé clic en la bicicleta o usá el sensor para pedalear</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Página de Juego Multijugador -->
        <div id="juegoMultijugador" class="page hidden">
            <div class="max-w-6xl mx-auto">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-800 mb-4">Modo Competencia</h1>
                    <p class="text-lg text-gray-600">¡Pedaleá o hacé clic para ganar. Tenés 1 minuto!</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                    <!-- Jugador Actual -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-semibold text-center mb-4 text-blue-600">Tu Progreso</h3>
                        <div class="text-center mb-6">
                            <div id="miVelocidad" class="text-3xl font-bold text-blue-600 mb-2">0 km/h</div>
                            <div id="miDistancia" class="text-2xl font-semibold text-green-600">0 m</div>
                        </div>
                        <div id="ciclistaPropio" class="text-center text-6xl bike-moving">
                            <i class="fas fa-biking"></i>
                        </div>
                    </div>
                    
                    <!-- Rival -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-semibold text-center mb-4 text-red-600">Rival</h3>
                        <div class="text-center mb-6">
                            <div id="rivalVelocidad" class="text-3xl font-bold text-red-600 mb-2">0 km/h</div>
                            <div id="distanciaRival" class="text-2xl font-semibold text-green-600">0 m</div>
                        </div>
                        <div id="ciclistaRival" class="text-center text-6xl cyclist-left">
                            <i class="fas fa-biking"></i>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-lg p-8">
                    <div class="text-center mb-6">
                        <div id="cuentaRegresivaMulti" class="text-5xl font-bold text-red-600 mb-2">60</div>
                        <p class="text-gray-600">Segundos restantes</p>
                    </div>
                    
                    <div class="text-center">
                        <div id="manubrioMulti" class="inline-block text-8xl cursor-pointer select-none hover:scale-110 transition-transform">
                            <i class="fas fa-bicycle"></i>
                        </div>
                        <div id="pedalAnimationMulti" class="text-4xl mt-4">
                            <i class="fas fa-circle-notch"></i>
                        </div>
                        <p class="mt-4 text-gray-600">Hacé clic en la bicicleta o usá el sensor para pedalear</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Página de Resultados -->
        <div id="resultados" class="page hidden">
            <div class="max-w-2xl mx-auto text-center">
                <h1 class="text-4xl font-bold text-gray-800 mb-8">¡Fin del Juego!</h1>
                
                <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
                    <div class="text-6xl mb-6">
                        <i id="resultIcon" class="fas fa-trophy text-yellow-500"></i>
                    </div>
                    
                    <h2 id="resultTitle" class="text-2xl font-semibold mb-6">Tu rendimiento:</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="text-center">
                            <div id="distanciaFinal" class="text-3xl font-bold text-green-600 mb-2">0 m</div>
                            <p class="text-gray-600">Distancia Final</p>
                        </div>
                        <div class="text-center">
                            <div id="velocidadMedia" class="text-3xl font-bold text-blue-600 mb-2">0 km/h</div>
                            <p class="text-gray-600">Velocidad Media</p>
                        </div>
                    </div>
                    
                    <div id="multiplayerResults" class="hidden mb-6">
                        <h3 class="text-xl font-semibold mb-4">Resultado de la Competencia</h3>
                        <div id="winnerMessage" class="text-lg font-medium"></div>
                    </div>
                    
                    <button id="volverInicio" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                        <i class="fas fa-home mr-2"></i>
                        Volver al Inicio
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Estado global de la aplicación
        const gameState = {
            nodemcuDetectado: false,
            jugador: 1,
            velocidad: 0,
            distancia: 0,
            velocidadMedia: 0,
            distanciaFinal: 0,
            distanciaRival: 0,
            rivalVelocidad: 0,
            gameTimer: null,
            gameActive: false,
            connectionMethod: null,
            isMultiplayer: false,
            clickCount: 0,
            lastClickTime: 0,
            rivalClickCount: 0
        };

        // Utilidades
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.remove('hidden');
            document.getElementById(pageId).classList.add('active');
        }

        function updateConnectionStatus(status, isConnected = false) {
            const statusElement = document.getElementById('estadoConexion');
            if (isConnected) {
                statusElement.innerHTML = `
                    <i class="fas fa-check-circle text-green-600"></i>
                    <span class="text-green-800 ml-2">${status}</span>
                `;
                statusElement.className = 'mb-6 p-4 rounded-lg bg-green-50 border border-green-200';
            } else {
                statusElement.innerHTML = `
                    <i class="fas fa-exclamation-triangle text-yellow-600"></i>
                    <span class="text-yellow-800 ml-2">${status}</span>
                `;
                statusElement.className = 'mb-6 p-4 rounded-lg bg-yellow-50 border border-yellow-200';
            }
        }

        function simulateNodeMCUDetection() {
            updateConnectionStatus('Buscando dispositivo NodeMCU...', false);
            
            setTimeout(() => {
                if (Math.random() > 0.3) { // 70% de probabilidad de "encontrar" el dispositivo
                    gameState.nodemcuDetectado = true;
                    updateConnectionStatus('¡NodeMCU detectado y conectado!', true);
                    setTimeout(() => {
                        showPage('seleccionModo');
                    }, 1500);
                } else {
                    updateConnectionStatus('No se detectó el dispositivo. Intente conectar por WiFi, Direct o USB.');
                }
            }, 2000);
        }

        function calculateSpeed(clickInterval) {
            // Simular velocidad basada en la frecuencia de clics
            if (clickInterval < 200) return Math.min(50, 50 * (200 - clickInterval) / 200);
            if (clickInterval < 500) return Math.min(30, 30 * (500 - clickInterval) / 300);
            if (clickInterval < 1000) return Math.min(15, 15 * (1000 - clickInterval) / 500);
            return 5;
        }

        function updateGameStats(isMultiplayer = false) {
            const currentTime = Date.now();
            const timeDiff = currentTime - gameState.lastClickTime;
            
            if (timeDiff > 0) {
                gameState.velocidad = calculateSpeed(timeDiff);
                gameState.distancia += gameState.velocidad / 3.6; // Convertir km/h a m/s y sumar
            }
            
            gameState.lastClickTime = currentTime;
            
            if (isMultiplayer) {
                document.getElementById('miVelocidad').textContent = `${Math.round(gameState.velocidad)} km/h`;
                document.getElementById('miDistancia').textContent = `${Math.round(gameState.distancia)} m`;
                
                // Simular rival
                gameState.rivalVelocidad = Math.random() * 40;
                gameState.distanciaRival += gameState.rivalVelocidad / 3.6;
                document.getElementById('rivalVelocidad').textContent = `${Math.round(gameState.rivalVelocidad)} km/h`;
                document.getElementById('distanciaRival').textContent = `${Math.round(gameState.distanciaRival)} m`;
                
                // Animar ciclistas
                if (gameState.velocidad > 10) {
                    document.getElementById('ciclistaPropio').classList.add('bike-moving');
                } else {
                    document.getElementById('ciclistaPropio').classList.remove('bike-moving');
                }
                
                if (gameState.rivalVelocidad > 10) {
                    document.getElementById('ciclistaRival').classList.add('bike-moving');
                } else {
                    document.getElementById('ciclistaRival').classList.remove('bike-moving');
                }
            } else {
                document.getElementById('velocidad').textContent = Math.round(gameState.velocidad);
                document.getElementById('distancia').textContent = Math.round(gameState.distancia);
                
                // Actualizar barra de velocidad
                const speedPercentage = Math.min(100, (gameState.velocidad / 50) * 100);
                document.getElementById('speedBar').style.width = `${speedPercentage}%`;
            }
        }

        function startGame(isMultiplayer = false) {
            gameState.gameActive = true;
            gameState.isMultiplayer = isMultiplayer;
            gameState.velocidad = 0;
            gameState.distancia = 0;
            gameState.distanciaRival = 0;
            gameState.clickCount = 0;
            gameState.rivalClickCount = 0;
            
            let timeLeft = 60;
            const timerElement = isMultiplayer ? 
                document.getElementById('cuentaRegresivaMulti') : 
                document.getElementById('cuentaRegresiva');
            
            gameState.gameTimer = setInterval(() => {
                timeLeft--;
                timerElement.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
        }

        function endGame() {
            gameState.gameActive = false;
            clearInterval(gameState.gameTimer);
            
            gameState.distanciaFinal = Math.round(gameState.distancia);
            gameState.velocidadMedia = Math.round(gameState.distancia / 60 * 3.6); // Convertir a km/h
            
            document.getElementById('distanciaFinal').textContent = `${gameState.distanciaFinal} m`;
            document.getElementById('velocidadMedia').textContent = `${gameState.velocidadMedia} km/h`;
            
            if (gameState.isMultiplayer) {
                const multiResults = document.getElementById('multiplayerResults');
                const winnerMessage = document.getElementById('winnerMessage');
                multiResults.classList.remove('hidden');
                
                if (gameState.distancia > gameState.distanciaRival) {
                    winnerMessage.innerHTML = '<span class="text-green-600">¡Ganaste!</span>';
                    document.getElementById('resultIcon').className = 'fas fa-trophy text-yellow-500';
                } else if (gameState.distancia < gameState.distanciaRival) {
                    winnerMessage.innerHTML = '<span class="text-red-600">Perdiste</span>';
                    document.getElementById('resultIcon').className = 'fas fa-medal text-gray-500';
                } else {
                    winnerMessage.innerHTML = '<span class="text-blue-600">¡Empate!</span>';
                    document.getElementById('resultIcon').className = 'fas fa-handshake text-blue-500';
                }
            }
            
            showPage('resultados');
        }

        function handlePedal(isMultiplayer = false) {
            if (!gameState.gameActive) return;
            
            gameState.clickCount++;
            updateGameStats(isMultiplayer);
            
            // Animaciones
            const manubrioElement = isMultiplayer ? 
                document.getElementById('manubrioMulti') : 
                document.getElementById('manubrio');
            const pedalElement = isMultiplayer ? 
                document.getElementById('pedalAnimationMulti') : 
                document.getElementById('pedalAnimation');
            
            manubrioElement.classList.add('handlebar-active');
            pedalElement.classList.add('pedaling');
            
            setTimeout(() => {
                manubrioElement.classList.remove('handlebar-active');
                pedalElement.classList.remove('pedaling');
            }, 200);
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Detectar NodeMCU
            document.getElementById('detectarNodeMCU').addEventListener('click', simulateNodeMCUDetection);
            
            // Métodos de conexión alternativos
            document.querySelectorAll('.connection-method').forEach(button => {
                button.addEventListener('click', function() {
                    gameState.connectionMethod = this.dataset.method;
                    gameState.nodemcuDetectado = true;
                    updateConnectionStatus(`Conectado via ${this.dataset.method}`, true);
                    setTimeout(() => {
                        showPage('seleccionModo');
                    }, 1500);
                });
            });
            
            // Selección de modo
            document.getElementById('modoUnJugador').addEventListener('click', function() {
                showPage('juegoUnJugador');
                startGame(false);
            });
            
            document.getElementById('modoMultijugador').addEventListener('click', function() {
                showPage('juegoMultijugador');
                startGame(true);
            });
            
            // Controles de juego
            document.getElementById('manubrio').addEventListener('click', () => handlePedal(false));
            document.getElementById('manubrioMulti').addEventListener('click', () => handlePedal(true));
            
            // Volver al inicio
            document.getElementById('volverInicio').addEventListener('click', function() {
                showPage('inicio');
                gameState.nodemcuDetectado = false;
                updateConnectionStatus('Esperando conexión del NodeMCU...', false);
            });
            
            // Controles de teclado
            document.addEventListener('keydown', function(e) {
                if (e.code === 'Space' && gameState.gameActive) {
                    e.preventDefault();
                    handlePedal(gameState.isMultiplayer);
                }
            });
            
            // Simular sensor infrarrojo con eventos táctiles
            document.addEventListener('touchstart', function(e) {
                if (gameState.gameActive && (e.target.id === 'manubrio' || e.target.id === 'manubrioMulti')) {
                    handlePedal(gameState.isMultiplayer);
                }
            });
        });

        // Simular datos del sensor infrarrojo (para desarrollo)
        if (gameState.connectionMethod === 'manual') {
            setInterval(() => {
                if (gameState.gameActive && Math.random() > 0.8) {
                    handlePedal(gameState.isMultiplayer);
                }
            }, 500);
        }
    </script>
</body>
</html>
